



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="介绍物联网基础概念">
      
      
      
        <meta name="author" content="WiSys Lob">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="zh">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>什么是MQTT - IoT Book</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#mqtt" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../.." title="IoT Book" class="md-header-nav__button md-logo">
          
            <img src="../../../../images/nicon.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              IoT Book
            </span>
            <span class="md-header-nav__topic">
              
                什么是MQTT
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../.." title="IoT Book" class="md-nav__button md-logo">
      
        <img src="../../../../images/nicon.png" width="48" height="48">
      
    </a>
    IoT Book
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../1. 前言/物联网导论/" title="一. 前言" class="md-nav__link">
      一. 前言
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../2. 物联网简介/物联网简介/" title="二. 物联网简介" class="md-nav__link">
      二. 物联网简介
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      三. 开发环境
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        三. 开发环境
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../平台搭建/android开发基础/" title="3.1 Android 环境" class="md-nav__link">
      3.1 Android 环境
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../平台搭建/matlab基础/" title="3.2 MATLAB 环境" class="md-nav__link">
      3.2 MATLAB 环境
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      四. 物联网网络协议
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        四. 物联网网络协议
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/物联网连接技术/" title="4.1 物联网连接技术" class="md-nav__link">
      4.1 物联网连接技术
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/4.2 Wi-Fi无线局域网/" title="4.2 Wi-Fi无线局域网" class="md-nav__link">
      4.2 Wi-Fi无线局域网
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/4.3 蓝牙/" title="4.3 蓝牙" class="md-nav__link">
      4.3 蓝牙
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/4.4 ZigBee/" title="4.4 ZigBee" class="md-nav__link">
      4.4 ZigBee
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/4.5 毫米波通信/" title="4.5 毫米波通信" class="md-nav__link">
      4.5 毫米波通信
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/4.6 可见光通信/" title="4.6 可见光通信" class="md-nav__link">
      4.6 可见光通信
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/4.7 低功耗广域网/" title="4.7 低功耗广域网" class="md-nav__link">
      4.7 低功耗广域网
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/蓝牙实验/" title="4.8 蓝牙连接实验" class="md-nav__link">
      4.8 蓝牙连接实验
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../3. 物联网通信协议/LoRa编码和通信实验/" title="4.9 LoRa编码和通信实验" class="md-nav__link">
      4.9 LoRa编码和通信实验
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      五. 物联网通信基础
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        五. 物联网通信基础
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../4. 物联网通信基础/5.1 采样和量化/" title="5.1 采样和量化" class="md-nav__link">
      5.1 采样和量化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../4. 物联网通信基础/5.2 傅里叶分析/" title="5.2 傅里叶分析" class="md-nav__link">
      5.2 傅里叶分析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../4. 物联网通信基础/5.3 无线信道/" title="5.3 无线信道" class="md-nav__link">
      5.3 无线信道
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../4. 物联网通信基础/5.4 滤波/" title="5.4 信号滤波" class="md-nav__link">
      5.4 信号滤波
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../4. 物联网通信基础/4.2 调制解调方法及其声音实现/" title="5.5 调制解调方法" class="md-nav__link">
      5.5 调制解调方法
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      六. 物联网网络构建技术
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        六. 物联网网络构建技术
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../8. 物联网网络构建/8.5 物联网多跳自组网网络协议/" title="6.1 物联网组网技术" class="md-nav__link">
      6.1 物联网组网技术
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../8. 物联网网络构建/8.1 低功耗物联网概述/" title="6.2 低占空比网络" class="md-nav__link">
      6.2 低占空比网络
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-3" type="checkbox" id="nav-6-3">
    
    <label class="md-nav__link" for="nav-6-3">
      6.3 网络冲突处理
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-3">
        6.3 网络冲突处理
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../8. 物联网网络构建/8.2.1 链路模型及网络容量/" title="6.3.1 链路模型及网络容量" class="md-nav__link">
      6.3.1 链路模型及网络容量
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../8. 物联网网络构建/8.2 网络冲突处理/" title="6.3.2 网络冲突处理方法" class="md-nav__link">
      6.3.2 网络冲突处理方法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../8. 物联网网络构建/8.2.2 zigzag实验/" title="6.3.2 实验：ZigZag声音实现" class="md-nav__link">
      6.3.2 实验：ZigZag声音实现
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-4" type="checkbox" id="nav-6-4">
    
    <label class="md-nav__link" for="nav-6-4">
      6.4 跨协议识别与通信
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-4">
        6.4 跨协议识别与通信
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../8. 物联网网络构建/8.3 跨协议识别/" title="6.4.1 跨协议识别" class="md-nav__link">
      6.4.1 跨协议识别
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../8. 物联网网络构建/8.4 跨协议通信/" title="6.4.2 跨协议通信" class="md-nav__link">
      6.4.2 跨协议通信
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      七. 物联网感知技术
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        七. 物联网感知技术
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">
    
    <label class="md-nav__link" for="nav-7-1">
      7.1 传感器感知
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        7.1 传感器感知
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/传感器感知/传感器/" title="7.1.1 传感器" class="md-nav__link">
      7.1.1 传感器
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/传感器感知/实验-传感器/" title="7.1.2 传感器实验" class="md-nav__link">
      7.1.2 传感器实验
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      7.2 行为识别
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        7.2 行为识别
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../404/" title="7.2.1 Wi-Fi 动作识别" class="md-nav__link">
      7.2.1 Wi-Fi 动作识别
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/智能手表手势识别/智能手表连接教程/智能手表连接教程/" title="7.2.2 智能手表手势识别" class="md-nav__link">
      7.2.2 智能手表手势识别
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/身份识别/频率选择/" title="7.3 身份认证" class="md-nav__link">
      7.3 身份认证
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-4" type="checkbox" id="nav-7-4">
    
    <label class="md-nav__link" for="nav-7-4">
      7.4 定位与追踪
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-4">
        7.4 定位与追踪
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/定位与追踪/无线测距/" title="7.4.1 无线测距" class="md-nav__link">
      7.4.1 无线测距
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/定位与追踪/定位技术/" title="7.4.2 定位技术" class="md-nav__link">
      7.4.2 定位技术
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/定位与追踪/追踪技术/" title="7.4.3 追踪技术" class="md-nav__link">
      7.4.3 追踪技术
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      八. 物联网综合应用平台
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        八. 物联网综合应用平台
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../5.物联网感知/定位感知实验.md" title="8.1 定位感知" class="md-nav__link">
      8.1 定位感知
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../阿里云平台/阿里云物联网平台介绍/" title="8.2 阿里云平台" class="md-nav__link">
      8.2 阿里云平台
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../LoRa测试床/LoRa测试床/" title="8.3 LoRa测试床" class="md-nav__link">
      8.3 LoRa测试床
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../物联网开发/物联网开发/" title="8.4 物联网开发" class="md-nav__link">
      8.4 物联网开发
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mqtt_1" class="md-nav__link">
    MQTT概述
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    几个重要概念
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mqtt_2" class="md-nav__link">
    MQTT协议数据包结构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mqtt_3" class="md-nav__link">
    MQTT通信流程
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="mqtt">什么是MQTT<a class="headerlink" href="#mqtt" title="Permanent link">&para;</a></h1>
<h2 id="mqtt_1">MQTT概述<a class="headerlink" href="#mqtt_1" title="Permanent link">&para;</a></h2>
<p>MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的轻量级通讯协议。该协议构建于TCP/IP协议上，由IBM在1999年发布。MQTT最大优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。</p>
<p>MQTT协议设计主要服从以下原则：</p>
<ul>
<li>（1）精简，只保留必要的功能；</li>
<li>（2）采用发布/订阅（Pub/Sub）模式，允许用户动态创建主题；</li>
<li>（3）考虑低带宽、高延迟、连接不稳定等因素；</li>
<li>（4）不对客户端计算能力做额外要求；</li>
<li>（5）提供服务质量管理；</li>
<li>（6）不对传输数据的类型与格式做额外要求，保持灵活性。</li>
</ul>
<blockquote>
<p>Ref: <a href="https://blog.csdn.net/aa1215018028/article/details/84888096">https://blog.csdn.net/aa1215018028/article/details/84888096</a></p>
</blockquote>
<p><img alt="" src="../res/images/mqtt_basics.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. MQTT协议基本架构</div>
</center></p>
<p>上图展示了MQTT协议的基本架构，可以看到MQTT的基本架构与传统基于客户端/服务器的通信协议类似，也包括作为客户端的MQTT client和作为服务器的MQTT broker两部分。但与传统客户端、服务器之间请求/回答的消息同步模式不同，MQTT采用发布/订阅的模式，从而解耦了消息发布者（Publisher）和消息订阅者（Subscriber）之间的关系。这么做的好处是发布者和订阅者之间不需要建立直接的联系，发布者只需要将消息发布到MQTT broker，由broker负责数据存储和广播，从而降低了连接建立的开销及对通信信道的要求。举一个更直观的例子，你打电话给朋友，一直要等到朋友接电话了才能够开始交流，是一个典型的同步请求/回答的场景；而给一个好友邮件列表发电子邮件就不一样，你发完电子邮件该干嘛干嘛，好友们到有空了去查看邮件就是了，是一个典型的异步发布/订阅的场景。由于以上特性，MQTT协议已成为 IoT 通信的标准之一，在各类物联网应用中被广泛使用。</p>
<blockquote>
<p>Ref: <a href="http://dataguild.org/?p=6817">http://dataguild.org/?p=6817</a></p>
</blockquote>
<h2 id="_1">几个重要概念<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>在继续介绍MQTT协议具体工作流程之前，我们来看一下MQTT协议中的几个重要概念：</p>
<ul>
<li>发布者（Publisher）：数据提供者，通常是传感器或其他可以产生数据的设备。</li>
<li>订阅者（Subscriber）：数据接收者，通过指定接收主题名，可以从服务器接收特定的数据。注意：消息的发布者和订阅者都是客户端，消息发布者同时也可以是消息订阅者。</li>
<li>消息代理/服务器（Broker）：接受来自客户端的网络连接，处理来自客户端的订阅和退订请求；接收发布者发布的应用信息，并向订阅的客户转发这些消息。此外，服务器通常还与数据库连接，实现数据的汇聚和存储。</li>
<li>订阅（Subscription）：订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。</li>
<li>会话（Session）：每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。</li>
<li>主题名（Topic Name）：连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。</li>
<li>主题筛选器（Topic Filter）：一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。</li>
<li>负载（Payload）：消息订阅者所具体接收的内容。 </li>
</ul>
<h2 id="mqtt_2">MQTT协议数据包结构<a class="headerlink" href="#mqtt_2" title="Permanent link">&para;</a></h2>
<p>在MQTT协议中，一个MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。MQTT数据包结构如下：</p>
<p><img alt="" src="../res/images/MQTT包结构.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. MQTT协议数据包结构</div>
</center></p>
<p>（1）固定头（Fixed header）。存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识。</p>
<p>（2）可变头（Variable header）。存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容。</p>
<p>（3）消息体（Payload）。存在于部分MQTT数据包中，表示客户端收到的具体内容。</p>
<p><strong>固定头</strong></p>
<p>固定头存在于所有MQTT数据包中，其结构如下：
<img alt="" src="../res/images/固定头结构.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. MQTT数据包固定头结构</div>
</center></p>
<p>固定头中第一字节的7-4位表明数据包类型，MQTT协议规定了包括“连接请求”、“发布确认”、“订阅确认”等15种不同类型的数据包。第一字节剩余的4个比特位为数据包的标识位，分别标识了以下三种信息：</p>
<ul>
<li>
<p>（1）DUP (1 bit)：发布消息的副本。用来在保证消息的可靠传输，如果设置为1，则在下面的变长中增加MessageId，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。</p>
</li>
<li>
<p>（2）QoS (2 bits)：发布消息的服务质量，即：保证消息传递的次数</p>
<table>
<thead>
<tr>
<th>内容</th>
<th>QoS</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>00</td>
<td>QoS 0</td>
<td>最多一次，即：&lt;=1</td>
</tr>
<tr>
<td>01</td>
<td>QoS 1</td>
<td>至少一次，即：&gt;=1</td>
</tr>
<tr>
<td>10</td>
<td>QoS 2</td>
<td>恰好一次，即：=1</td>
</tr>
<tr>
<td>11</td>
<td>-</td>
<td>预留</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>（3）RETAIN (1 bit)：发布保留标识，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果设有那么推送至当前订阅者后释放。</p>
</li>
</ul>
<p>固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的。这一字节是可以扩展，其保存机制：前7位用于保存长度，后一部用做标识。当最后一位为1时，表示长度不足，需要使用二个字节继续保存。</p>
<p><strong>可变头</strong></p>
<p>MQTT数据包中包含一个可变头，它驻位于固定的头和负载之间。可变头的内容因数据包类型而不同，较常的应用是作为包的标识。</p>
<p><strong>Payload消息体</strong></p>
<p>Payload消息体位MQTT数据包的第三部分，包含CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE四种类型的消息：</p>
<ul>
<li>（1）CONNECT：消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码。</li>
<li>（2）SUBSCRIBE：消息体内容是一系列的要订阅的主题以及QoS。</li>
<li>（3）SUBACK：消息体内容是服务器对于SUBSCRIBE所申请的主题及QoS进行确认和回复。</li>
<li>（4）UNSUBSCRIBE：消息体内容是要订阅的主题。</li>
</ul>
<blockquote>
<p>Ref: <a href="https://www.jianshu.com/p/de88edf8e023">https://www.jianshu.com/p/de88edf8e023</a></p>
</blockquote>
<h2 id="mqtt_3">MQTT通信流程<a class="headerlink" href="#mqtt_3" title="Permanent link">&para;</a></h2>
<p>MQTT根据支持的服务质量(Quality of Service)不同，客户端与服务器之间的通信流程也不同。MQTT支持三种QoS，分别是0、1、2。级别越高，交互越复杂，越能保证正确性和到达率，但是开销也更大。</p>
<p>QoS 0 是MQTT所有支持的服务质量中最基本、也是最简单的一种，它提供一种尽力而为的服务，即消息发送者确保有数据产生时向服务器发送消息，但是遇到意外导致传输失败时并不会重传。</p>
<p><img alt="" src="../res/images/QoS0.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. QoS 0下通信流程</div>
</center></p>
<p>QoS 1 在 Qos 0 的基础上增加了消息确认和重传机制，因此可以保证发布者发布的数据可以被服务器推送至少一次。在这种模式下，如果存在网络延时、确认包丢失等不确定因素，当然可能造成消息的重复推送。</p>
<p><img alt="" src="../res/images/QoS1.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. QoS 1下通信流程</div>
</center></p>
<p>QoS 2 可以保证发布饿着的数据包被所有订阅者恰好接收一次。保证这种语义肯定会减少并发或者增加延时，因此只适合用于不能接受丢包或者重复消息的应用场景。</p>
<p><img alt="" src="../res/images/QoS2.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. QoS 2下通信流程</div>
</center></p>
<blockquote>
<p>Ref: <a href="https://emqx-enterprise-docs-en.readthedocs.io/en/latest/mqtt.html">https://emqx-enterprise-docs-en.readthedocs.io/en/latest/mqtt.html</a></p>
</blockquote>
<h1 id="mqtt_4">为什么选择MQTT<a class="headerlink" href="#mqtt_4" title="Permanent link">&para;</a></h1>
<p>MQTT 以其简单、轻量、灵活的特点，受到了 IoT 开发人员的青睐，在实际 IoT 系统中得到了广泛应用。轻量级的 MQTT 协议可在严重受限的设备硬件和高延迟/带宽有限的网络上实现，它的灵活性使得为 IoT 设备和服务的多样化应用场景提供支持成为可能。</p>
<p>为了了解为什么 MQTT 如此适合 IoT 开发场景，我们首先来分析一下为什么其他流行网络协议未在 IoT 中得到成功应用。</p>
<h2 id="http">HTTP<a class="headerlink" href="#http" title="Permanent link">&para;</a></h2>
<p>在互联网时代，大多数开发人员已经熟悉 HTTP Web 服务。那么为什么不让 IoT 设备连接到 Web 服务？设备可采用 HTTP 请求的形式发送其数据，并采用 HTTP 响应的形式从系统接收更新，但这种请求和响应模式存在一些严重的局限性：</p>
<ul>
<li>（1）<mark>HTTP 是一种同步协议，客户端需要等待服务器响应</mark>。在 IoT 领域，设备的能耗、数量以及网络低可靠、高延迟的特点都使得上述同步通信成为问题。异步消息协议更适合 IoT 应用程序。传感器发送读数，让网络确定将其传送到目标设备和服务的最佳路线和时间。</li>
<li>（2）<mark>HTTP 是单向的，客户端必须发起连接才能获取数据</mark>。在 IoT 应用程序中，设备或传感器通常是客户端，这意味着它们无法被动地接收来自网络的命令。</li>
<li>（3）<mark>HTTP 是一种 1-1 协议</mark>。客户端发出请求，服务器进行响应。将消息传送到网络上的所有设备上，不但很困难，而且成本很高，而这是 IoT 应用程序中的一种常见使用情况。</li>
<li>（4）<mark>HTTP 是一种有许多标头和规则的重量级协议</mark>。这意味着除了内容负载外，由协议规定的包头、传输规则等会带来许多额外负载，因此不适合于受限的网络。</li>
</ul>
<p>出于上述原因，不仅仅在物联网场景中，实际上大部分高性能、可扩展的系统也都使用异步消息总线来进行内部数据交换，而不使用 Web 服务。</p>
<blockquote>
<p>Ref: <a href="https://www.ibm.com/developerworks/cn/iot/iot-mqtt-why-good-for-iot/index.html?_blank">https://www.ibm.com/developerworks/cn/iot/iot-mqtt-why-good-for-iot/index.html?_blank</a></p>
</blockquote>
<h2 id="xmpp">XMPP<a class="headerlink" href="#xmpp" title="Permanent link">&para;</a></h2>
<p>可扩展消息与存在协议 (Extensible Messaging and Presence Protocol, XMPP) 是一种以XML为基础的开放式即时通信协议。作为一种对等即时消息 (IM) 协议，XMPP高度依赖于支持 IM 用例的特性，比如存在状态和介质连接。与 MQTT 相比，它在设备和网络上需要的资源都要多得多。</p>
<p>XMPP网络是基于服务器的（即客户端之间彼此不直接交谈），所有通过XMPP通信的用户都需要预先绑定一个服务器。Jabber识别符（JID）是用户登录时所使用的账号，看起来通常像一个电子邮件地址，如<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#111;&#109;&#101;&#111;&#110;&#101;&#64;&#101;&#120;&#97;&#109;&#112;&#108;&#101;&#46;&#99;&#111;&#109;">&#115;&#111;&#109;&#101;&#111;&#110;&#101;&#64;&#101;&#120;&#97;&#109;&#112;&#108;&#101;&#46;&#99;&#111;&#109;</a>：前半部分为用户名，后半部分为XMPP服务器域名，两个字段以@符号区隔。</p>
<p>举个例子，假设朱丽叶（<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#106;&#117;&#108;&#105;&#101;&#116;&#64;&#99;&#97;&#112;&#117;&#108;&#101;&#116;&#46;&#99;&#111;&#109;">&#106;&#117;&#108;&#105;&#101;&#116;&#64;&#99;&#97;&#112;&#117;&#108;&#101;&#116;&#46;&#99;&#111;&#109;</a>）想和罗密欧（<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#114;&#111;&#109;&#101;&#111;&#64;&#109;&#111;&#110;&#116;&#97;&#103;&#117;&#101;&#46;&#110;&#101;&#116;">&#114;&#111;&#109;&#101;&#111;&#64;&#109;&#111;&#110;&#116;&#97;&#103;&#117;&#101;&#46;&#110;&#101;&#116;</a>）通话，他们两人的账号分别在Capulet.com及Montague.net的服务器上。当朱丽叶输入消息并按下发送钮之后，一连串的事件就发生了：</p>
<ol>
<li>朱丽叶的XMPP客户端将她的消息发送到Capulet.com XMPP服务器。</li>
<li>Capulet.com XMPP服务器打开与Montague.net XMPP服务器的连接。</li>
<li>Montague.net XMPP服务器将消息寄送给罗密欧。如果他当前不在在线，那么存储消息以待稍后寄送。</li>
</ol>
<p><img alt="" src="../res/images/XMPP.png" /></p>
<p>XMPP协议允许通信的双方来自不同的服务器供应商，而他们彼此传讯时，不须拥有对方服务器的账号，也不须成为对方业者的会员。但XMPP协议也存在问题，首要的就是==数据负载太重==，随着通常超过70％的XMPP协议的服务器的数据流量的存在和近60％的被重复转发。其次是==二进制数据传输受限==，XMPP传输单一的XML文件，因此要透过XMPP传输二进制数据，需先将二进制数据以Base64编码。</p>
<blockquote>
<p>Ref: <a href="https://en.wikipedia.org/wiki/XMPP">https://en.wikipedia.org/wiki/XMPP</a></p>
</blockquote>
<p>MQTT以其体量轻、灵活性高、消息模式为发布/订阅等特点，解决上述协议应用在 IoT 场景中所遇到的问题。并且 MQTT 对传输内容的格式不做额外要求，因此用户可以根据自己的应用需求设计或更改 MQTT payload的数据格式。</p>
<h1 id="mqtt_5">MQTT服务器搭建<a class="headerlink" href="#mqtt_5" title="Permanent link">&para;</a></h1>
<p>MQTT 服务器，即 MQTT broker，负责接收用户发送的应用数据，向订阅者转发消息，并将汇聚数据将其存储到云端数据库中。</p>
<p>我们使用 mosquitto 搭建MQTT服务器，mosquitto 是由 Eclipse 开发的一款开源 MQTT broker，它可以提供轻量级的消息推送/订阅服务。mosquitto提供了丰富的API，开发者可以很方便地在 mosquitto 代码的基础上进行个性化定制。</p>
<h2 id="_2">编译安装<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>下载<a href="https://mosquitto.org/download/">mosquitto源码</a>，解压后编译安装。(以下流程在Ubuntu 19.04测试通过)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>tar zxvf mosquitto-1.6.7.tar.gz
<span class="nb">cd</span> mosquitto-1.6.7
make
sudo make install
</pre></div>
</td></tr></table>

<p><strong>安装过程中可能出现的问题</strong></p>
<p>(1) 编译找不到openssl/ssl.h</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo apt-get install openssl
sudo apt-get install libssl-dev
</pre></div>
</td></tr></table>

<p>(2) 编译过程找不到ares.h</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo apt-get install libc-ares-dev
</pre></div>
</td></tr></table>

<p>(3) 编译过程找不到uuid/uuid.h</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sudo apt-get install uuid-dev
</pre></div>
</td></tr></table>

<p>(4) make: g++：命令未找到  </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># 安装g++编译器</span>
sudo apt-get install g++
</pre></div>
</td></tr></table>

<p>完成安装后，在命令行验证其功能：</p>
<p>打开三个终端，分别作为服务器、订阅者和发布者。</p>
<ul>
<li>一号终端作为服务器，执行<code>mosquitto</code>，可以看到输出如下：</li>
</ul>
<p><img alt="" src="../res/images/install-test-1.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. 一号终端输出</div>
</center></p>
<p>默认情况下，mosquitto 服务器监听1883端口。</p>
<ul>
<li>二号终端作为订阅者，执行<code>mosquitto_sub -t "my_topic"</code>，表示订阅主题<code>"my_topic"</code>，当有发布者发布该主题的内容时，服务器会将内容推送至二号终端并显示（二号终端在刚启动时无输出）：</li>
</ul>
<p><img alt="" src="../res/images/install-test-2.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. 二号终端输出</div>
</center></p>
<p>在二号终端启动后，一号终端（服务器）会相应的输出，提示来自订阅者的连接</p>
<p><img alt="" src="../res/images/install-test-3.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. 订阅者连接到服务器后，一号终端的输出</div>
</center></p>
<ul>
<li>三号终端作为发布者，执行<code>mosquitto_pub -t "my_topic" -m "Test Message"</code>，表示发布主题为<code>"my_topic"</code>、内容为<code>"Test Message"</code>的信息。默认配置下，发布者使用QoS0模式，因此完成数据发送后即结束进程。</li>
</ul>
<p><img alt="" src="../res/images/install-test-5.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. 一号终端输出</div>
</center></p>
<p>上图为一号终端（服务器）的输出，可以看到发布者“连接-传输-断开连接”的过程。</p>
<p><img alt="" src="../res/images/install-test-4.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. 二号终端输出</div>
</center></p>
<p>上图为二号终端输出，可以看到发布者发布的内容已经通过服务器推送至二号终端（订阅者）。</p>
<p><strong>运行过程中可能出现的问题</strong></p>
<p>(1) 使用过程中找不到libmosquitto.so.1：<code>error while loading shared libraries: libmosquitto.so.1: cannot open shared object file: No such file or directory</code></p>
<p>解决方法：修改libmosquitto.so位置</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># 创建链接</span>
sudo ln -s /usr/local/lib/libmosquitto.so.1 /usr/lib/libmosquitto.so.1
<span class="c1"># 更新动态链接库</span>
sudo ldconfig
</pre></div>
</td></tr></table>

<h2 id="_3">增加用户认证功能<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>初始状态的 mosquitto 不支持用户认证，即任意设备都可以向服务器订阅或发布消息。出于数据安全性考虑，我们需要在现有 mosquitto 的基础上增加用户认证功能，使只有通过合法认证的用户才可以订阅或发布消息。</p>
<p>我们使用 GitHub 上的一个开源 Mosquitto 认证插件。首先下载<a href="https://github.com/jpmens/mosquitto-auth-plug">Mosquitto认证插件</a>，解压后配置：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>tar zxvf mosquitto-auth-plug-0.1.3.tar.gz
<span class="nb">cd</span> mosquitto-auth-plug-0.1.3/
<span class="c1"># 基于初始配置文件进行配置</span>
cp config.mk.in config.mk
</pre></div>
</td></tr></table>

<p>在config.mk中，除了<code>BACKEND_MYSQL</code>这一行是<code>yes</code>，其余行都是<code>no</code>。<code>MOSQUITTO_SRC</code>一行输入<code>mosquitto</code>的源码路径，即安装步骤中 mosquitto 的解压路径（例如<code>MOSQUITTO_SRC = /home/iot//Document/mosquitto-1.6.7</code>）。在<code>OPENSSLDIR</code>一行输入<code>openssl</code>的路径，可用<code>openssl version -a</code>查看<code>openssl</code>路径（例如<code>OPENSSLDIR = /usr/lib/ssl</code>）。</p>
<p><img alt="" src="../res/images/auth-config.png" />
<center>
<div style="color:orange; border-bottom: 1px solid #d9d9d9;
display: inline-block;
color: #999;
padding: 2px;">图. Mosquitto 认证插件配置</div>
</center></p>
<p>编译 mosquitto-auth-plug，将编译生成的动态库 auth-plug.so 移动到 mosquitto 的安装目录（/etc/mosquitto/）中：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> mosquitto-auth-plug-0.1.3/
make
sudo cp auth-plug.so /etc/mosquitto/
</pre></div>
</td></tr></table>

<p><strong>安装过程中可能出现的问题</strong>
(1) mysql未安装 <code>mysql.h: No such file or directory #include &lt;mysql.h&gt;</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># 安装mysql</span>
sudo apt-get install mysql-server
sudo apt install mysql-client
sudo apt install libmysqlclient-dev
</pre></div>
</td></tr></table>

<p>(2) 函数参数类型冲突<code>error: conflicting types for 'mosquitto_auth_psk_key_get'</code></p>
<p><img alt="" src="../res/images/auth-err.png" /></p>
<p>错误原因：函数声明中参数<code>struct mosquitto *client</code>前有<code>const</code>，但在函数实现中没有<code>const</code>，较低版本的g++会在编译时报错。</p>
<p>解决方案：提高g++版本，或直接修改源码，在函数实现中加上<code>const</code>。</p>
<p>配置 mosquitto ，使用户认证插件生效。可以在mosquitto插件目录中配置文件的基础上直接修改，然后将配置文件复制到mosquitto的配置目录（/etc/mosquitto/）中：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> mosquitto-auth-plug-0.1.3/
sudo cp examples/mosquitto-mysql.conf /etc/mosquitto/mosquitto.conf
</pre></div>
</td></tr></table>

<p>修改/etc/mosquitto/mosquitto.conf，具体修改配置如下：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>auth_plugin /etc/mosquitto/auth-plug.so          <span class="c1"># 认证插件动态库位置</span>
auth_opt_backends mysql                          <span class="c1"># 插件支持的服务</span>
<span class="c1">#auth_opt_cdbname pwdb.cdb</span>
auth_opt_host localhost                          <span class="c1"># 数据库IP</span>
auth_opt_port <span class="m">3306</span>                               <span class="c1"># 数据库端口</span>
auth_opt_dbname mqtt_user                        <span class="c1"># 数据库名称</span>
auth_opt_user root                               <span class="c1"># 数据库用户名</span>
auth_opt_pass <span class="m">12345</span>                              <span class="c1"># 数据库密码</span>
auth_opt_userquery SELECT pw FROM users WHERE <span class="nv">username</span> <span class="o">=</span> <span class="s1">&#39;%s&#39;</span>   <span class="c1"># 用户认证查询语句</span>
auth_opt_superquery SELECT IFNULL<span class="o">(</span>COUNT<span class="o">(</span>*<span class="o">)</span>, <span class="m">0</span><span class="o">)</span> FROM users WHERE <span class="nv">username</span> <span class="o">=</span> <span class="s1">&#39; %s&#39;</span> AND <span class="nv">super</span> <span class="o">=</span> <span class="m">1</span>                                            <span class="c1"># 超级用户查询语句</span>
auth_opt_aclquery SELECT topic FROM acls WHERE <span class="nv">username</span> <span class="o">=</span> <span class="s1">&#39;%s&#39;</span>    <span class="c1"># 话题查询语句</span>
</pre></div>
</td></tr></table>

<p>所有的用户信息都将以表的形式存储在MySQL数据库中。在mysql中创建名为mqtt_user的数据库，并将<a href="https://raw.githubusercontent.com/549642238/private_IoT_platform/master/mysql.sql">mysql.sql</a>导入：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mysql -P <span class="m">3306</span> -u root -p mqtt_user&lt;~/mysql.sql
</pre></div>
</td></tr></table>

<p>导入后可以看到数据库中有以下表：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mysql&gt; show tables<span class="p">;</span>
+---------------------+
<span class="p">|</span> Tables_in_mqtt_user <span class="p">|</span>
+---------------------+
<span class="p">|</span> acls                <span class="p">|</span>
<span class="p">|</span> recorddata          <span class="p">|</span>
<span class="p">|</span> users               <span class="p">|</span>
+---------------------+
<span class="m">3</span> rows in <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>
</pre></div>
</td></tr></table>

<p>在<code>mysql.sql</code>中，我们向<code>users</code>表插入了一条用户名为<code>iot</code>，密码为<code>12345</code>的数据：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mysql&gt; <span class="k">select</span> * from users<span class="p">;</span>
+----+----------+---------------------------------------------------------------------+-------+
<span class="p">|</span> id <span class="p">|</span> username <span class="p">|</span> pw                                                                  <span class="p">|</span> super <span class="p">|</span>
+----+----------+---------------------------------------------------------------------+-------+
<span class="p">|</span>  <span class="m">1</span> <span class="p">|</span> iot      <span class="p">|</span> PBKDF2<span class="nv">$sha256$901$3</span>sa15aTb0ikHlLDy<span class="nv">$7</span>lthK1OnUyWL5oFXHMoFNEocp6oqyT+p <span class="p">|</span>     <span class="m">0</span> <span class="p">|</span>
+----+----------+---------------------------------------------------------------------+-------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>
</pre></div>
</td></tr></table>

<!-- MySQL新增用户：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mysql&gt; CREATE USER <span class="s1">&#39;iot&#39;</span>@<span class="s1">&#39;%&#39;</span> IDENTIFIED BY <span class="s1">&#39;11789&#39;</span><span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>
</pre></div>
</td></tr></table>

MySQL创建数据库：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mysql&gt; create database mqtt_user default charset utf8 collate utf8_general_ci<span class="p">;</span>
Query OK, <span class="m">1</span> row affected <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>
<span class="sb">```</span> --&gt;

完成配置后，我们再来测试一下 mosquitto 是否具备了用户认证能力。

同样打开三个终端，在一号终端执行<span class="sb">`</span>mosquitto -c /etc/mosquitto/mosquitto.conf -v<span class="sb">`</span>：

!<span class="o">[](</span>res/images/sql-test-1.png<span class="o">)</span>
&lt;center&gt;
&lt;div <span class="nv">style</span><span class="o">=</span><span class="s2">&quot;color:orange; border-bottom: 1px solid #d9d9d9;</span>
<span class="s2">display: inline-block;</span>
<span class="s2">color: #999;</span>
<span class="s2">padding: 2px;&quot;</span>&gt;图. 配置认证后，一号终端输出&lt;/div&gt;
&lt;/center&gt;

二号终端执行<span class="sb">`</span>mosquitto_sub -t <span class="s2">&quot;mytopic&quot;</span> -u iot -P <span class="m">12345</span><span class="sb">`</span>

!<span class="o">[](</span>res/images/sql-test-2.png<span class="o">)</span>

!<span class="o">[](</span>res/images/sql-test-3.png<span class="o">)</span>
&lt;center&gt;
&lt;div <span class="nv">style</span><span class="o">=</span><span class="s2">&quot;color:orange; border-bottom: 1px solid #d9d9d9;</span>
<span class="s2">display: inline-block;</span>
<span class="s2">color: #999;</span>
<span class="s2">padding: 2px;&quot;</span>&gt;图. 只有通过认证的合法用户才可以订阅&lt;/div&gt;
&lt;/center&gt;

如上图所示，只有通过认证的合法用户才可以向服务发起订阅请求。

三号终端执行<span class="sb">`</span>mosquitto_pub -m <span class="s2">&quot;Test Message&quot;</span> -t <span class="s2">&quot;mytopic&quot;</span> -u iot -P <span class="m">12345</span><span class="sb">`</span>。 同样，也只有当用户名和密码通过服务器认证，三号终端发布的消息才会被服务器接收并广播给订阅者。

到此为止，只要对mqtt_user数据库内的表进行增删改就可以达到用户、话题的管理效果。

<span class="c1">## 数据持久化</span>

到目前为止，服务器仅仅扮演了一个转发数据的代理的角色，最主要的数据存储功能还没有实现。因此我们需要为服务器增加数据持久化功能，令服务器将接收到的数据保存到数据库中。

mosquitto 没有提供数据持久化的接口，但我们可以通过修改源码，将收到的数据存入 MySQL 数据库。mosquitto使用C语言，因此在下面的步骤中我们将涉及C语言的数据库操作，有不熟悉的同学可以先学习一下 <span class="o">[</span>MySQL C语言API<span class="o">](</span>https://dev.mysql.com/doc/refman/5.5/en/c-api-function-overview.html<span class="o">)</span>。

在 <span class="sb">`</span>mosquitto-1.6.7/src<span class="sb">`</span> 目录新建 <span class="sb">`</span>diy_data_process.h<span class="sb">`</span> 和 <span class="sb">`</span>diy_data_process.c<span class="sb">`</span> 文件，用于在服务器端进行数据持久化操作。首先是连接数据库：

在 <span class="sb">`</span>diy_data_process.h<span class="sb">`</span> 导入 <span class="sb">`</span>mysql.h<span class="sb">`</span> 头文件，并声明连接数据库所需要的参数。

<span class="sb">```</span>C
<span class="c1">#include &quot;mysql/mysql.h&quot;</span>

// 数据库连接参数
<span class="c1">#define DBhost &quot;localhost&quot;              // 数据库IP</span>
<span class="c1">#define DBuser &quot;root&quot;                   // 数据库用户名</span>
<span class="c1">#define DBpass &quot;12345&quot;                  // 数据库密码</span>
<span class="c1">#define DBdb &quot;mqtt_user&quot;                // 数据库名称</span>

// 函数声明
int connectDB<span class="o">()</span><span class="p">;</span>
</pre></div>
</td></tr></table>

在 `diy_data_process.c` 中实现连接数据库函数，最关键的一步是调用`mysql_real_connect()` 建立数据库操作句柄`mysqlDataStore`与数据库之间的关联。

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">MYSQL</span> <span class="n">mysqlDataStore</span><span class="p">;</span>                            <span class="c1">// 数据库操作句柄</span>

<span class="kt">int</span> <span class="nf">connectDB</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mysql_library_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">mysql_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysqlDataStore</span><span class="p">);</span>
    <span class="n">mysql_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysqlDataStore</span><span class="p">,</span> <span class="n">MYSQL_OPT_RECONNECT</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mysql_real_connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysqlDataStore</span><span class="p">,</span><span class="n">DBhost</span><span class="p">,</span><span class="n">DBuser</span><span class="p">,</span><span class="n">DBpass</span><span class="p">,</span><span class="n">DBdb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysqlDataStore</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

断开数据库连接函数，实现如下：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">disconnectDB</span><span class="p">(){</span>
    <span class="n">mysql_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysqlDataStore</span><span class="p">);</span>
    <span class="n">mysql_library_end</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

上述数据库连接/断开函数需要在`mosquitto.c`中被调用，具体代码如下:

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">extern</span> <span class="n">MYSQL</span> <span class="n">mysqlDataStore</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">connectDB</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>                   <span class="c1">// 连接用户数据存储数据库</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connect database error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* Other Codes */</span>
    <span class="n">disconnectDB</span><span class="p">();</span>                         <span class="c1">// 断开用户数据存储数据库</span>
    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

接下来我们考虑如何解析服务器收到的数据包，提取其内容并存入数据库。mqtt 数据包的内容部分可以使用 JSON 键值对的形式打包数据，这样做的优点是: 确定每个数据归属于哪个属性, 防止数据被错误地归属到其他的属性中, 保证信息的准确性。

JSON (JavaScript Object Notation) 是一种轻量级的数据交换格式，易于人阅读和编写，同时也易于机器解析和生成。但是在C语言中，没有 JSON 对应的内建数据结构，因此我们需要导入 CJSON。 CJSON 是C语言写的一个开源的 JSON 解析库，用起来比较简单、方便。CJSON 的源码可以[从网络直接下载](http://sourceforge.net/projects/cjson/)，在test.c文件中有很多使用的例子，如果不明白使用方法可以看看cJSON.h和cJSON.c，不是太深奥。实际上使用一个双链表来记录JSON数据，然后对这个双链表进行增删改查等操作。下载 CJSON 后，将`CJSON.h`和`CJSON.c`复制到`mosquitto-1.6.7/src` 目录下，并在`diy_data_process.h` 中 include 头文件`CJSON.h`。

接下来实现数据包内容解析和存储功能。在`diy_data_process.c` 中新建函数 `recordData()`:

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cm">/** 解析数据包内容，并存入数据库</span>
<span class="cm"> * content     数据包内容，以字符数组的形式保存在内存中</span>
<span class="cm"> * username    发布者用户名</span>
<span class="cm"> * topic       主题</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">recordData</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">content</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">username</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">topic</span><span class="p">){</span>
    <span class="c1">// 结构化数据包内容（字符数组 -&gt; JSON 结构体）</span>
    <span class="n">cJSON</span><span class="o">*</span> <span class="n">pJson</span> <span class="o">=</span> <span class="n">cJSON_Parse</span><span class="p">(</span><span class="n">content</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">pJson</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">itemNumber</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
        <span class="c1">// 自定义属性数组</span>
        <span class="kt">char</span> <span class="n">items</span><span class="p">[</span><span class="mi">19</span><span class="p">][</span><span class="mi">15</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="s">&quot;temperature&quot;</span><span class="p">,</span> <span class="s">&quot;soil_humidity&quot;</span><span class="p">,</span> <span class="s">&quot;humidity&quot;</span><span class="p">,</span> <span class="s">&quot;pm25&quot;</span><span class="p">,</span> <span class="s">&quot;light&quot;</span><span class="p">,</span> <span class="s">&quot;accelerometer&quot;</span><span class="p">,</span> <span class="s">&quot;gyro&quot;</span><span class="p">,</span> <span class="s">&quot;co2&quot;</span><span class="p">,</span> <span class="s">&quot;voice&quot;</span><span class="p">,</span> <span class="s">&quot;sound&quot;</span><span class="p">,</span> <span class="s">&quot;diy_funcA&quot;</span><span class="p">,</span> <span class="s">&quot;diy_funcB&quot;</span><span class="p">,</span> <span class="s">&quot;led&quot;</span><span class="p">,</span> <span class="s">&quot;relay&quot;</span><span class="p">,</span> <span class="s">&quot;motor&quot;</span><span class="p">,</span> <span class="s">&quot;display&quot;</span><span class="p">,</span> <span class="s">&quot;buzzer&quot;</span><span class="p">,</span> <span class="s">&quot;speaker&quot;</span><span class="p">};</span>
        <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">dataItem</span><span class="p">[</span><span class="mi">120</span><span class="p">];</span>
        <span class="c1">// 从 JSON 结构体中提取上述各属性的值</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">itemNumber</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">extractItem</span><span class="p">(</span><span class="n">pJson</span><span class="p">,</span> <span class="n">dataItem</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="c1">// 若该属性值非空，添加至data字符串，稍后存入数据库</span>
            <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dataItem</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
                <span class="n">strcat</span><span class="p">(</span><span class="n">strcat</span><span class="p">(</span><span class="n">strcat</span><span class="p">(</span><span class="n">strcat</span><span class="p">(</span><span class="n">strcat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">),</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">),</span><span class="n">dataItem</span><span class="p">),</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">,&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="n">data</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;}&#39;</span><span class="p">;</span>
        <span class="n">data</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
        <span class="c1">// 以字符串形式将数据包内容存入数据库</span>
        <span class="kt">char</span> <span class="n">sql</span><span class="p">[</span><span class="mi">300</span><span class="p">];</span>
        <span class="n">mysql_ping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysqlDataStore</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">strcat</span><span class="p">(</span><span class="n">strcat</span><span class="p">(</span><span class="n">strcat</span><span class="p">(</span><span class="n">strcpy</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="s">&quot;INSERT INTO recorddata(username, data, date) VALUES(&#39;&quot;</span><span class="p">),</span><span class="n">username</span><span class="p">),</span><span class="s">&quot;&#39;,&#39;&quot;</span><span class="p">),</span><span class="n">data</span><span class="p">),</span><span class="s">&quot;&#39;,NOW())&quot;</span><span class="p">);</span>
        <span class="n">mysql_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysqlDataStore</span><span class="p">,</span> <span class="n">sql</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">cJSON_Delete</span><span class="p">(</span><span class="n">pJson</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

接下来我们在`mosquitto/src/handle_publish.c`中调用上面实现的`recordData()`函数，`handle_publish.c`的作用是处理发布者发送的数据包。在`int handle__publish(struct mosquitto_db *db, struct mosquitto *context)`中添加以下代码

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cm">/* After checking for topic access */</span>
<span class="n">recordData</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">topic</span><span class="p">);</span> <span class="c1">// 使用自定义数据处理库</span>
</pre></div>
</td></tr></table>

`payload`是 mosquitto 中定义的存储数据包内容的结构体，有兴趣的同学可以自行查阅源码。注意调用上述函数前，在`mosquitto_broker.h`中引入头文件`diy_data_process.h`。

最后，在`mosquitto/src/Makefile`中添加以下代码，使得我们新增的文件被编译到项目中：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nv">OBJS</span> <span class="o">=</span>  cJSON.o <span class="se">\</span>
        diy_data_process.o <span class="se">\</span>

cJSON.o : cJSON.c cJSON.h
    <span class="si">${</span><span class="nv">CROSS_COMPILE</span><span class="si">}${</span><span class="nv">CC</span><span class="si">}</span> <span class="k">$(</span>BROKER_CFLAGS<span class="k">)</span> -c $&lt; -o <span class="nv">$@</span>

diy_data_process.o : diy_data_process.c diy_data_process.h
    <span class="si">${</span><span class="nv">CROSS_COMPILE</span><span class="si">}${</span><span class="nv">CC</span><span class="si">}</span> <span class="k">$(</span>BROKER_CFLAGS<span class="k">)</span> -c $&lt; -o <span class="nv">$@</span>
</pre></div>
</td></tr></table>

最后编译我们修改后的代码，并重新安装：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> mosquitto-1.6.7/
make clean
make
sudo make install
</pre></div>
</td></tr></table>

**编译过程中可能出现的问题**
(1) `undefined reference to 'mysql_server_end'` 或 `undefined reference to 'mysql_init'`

这是因为编译器找不到mysql_init,mysql_close等的具体实现。虽然我们包括了正确的头文件，但是我们在编译的时候还是要连接确定的库。对于一些常用的函数的实现，gcc编译器会自动去连接一些常用库，这样我们就没有必要自己去指定了。但某些版本的gcc编译器无法识别 MySQL 的库，因此我们需要手动包含一下：

将`libmysqlclient.a`文件复制到`/mosquitto-1.6.7/lib`目录下，修改`/mosquitto-1.6.7/config.mk`，将原编译指令改成如下内容：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Line 151</span>
ifneq <span class="o">(</span><span class="k">$(</span>or <span class="k">$(</span>findstring <span class="k">$(</span>UNAME<span class="k">)</span>,FreeBSD<span class="k">)</span>, <span class="k">$(</span>findstring <span class="k">$(</span>UNAME<span class="k">)</span>,OpenBSD<span class="k">)</span>, <span class="k">$(</span>findstring <span class="k">$(</span>UNAME<span class="k">)</span>,NetBSD<span class="k">))</span>,<span class="o">)</span>
    BROKER_LDADD:<span class="o">=</span><span class="k">$(</span>BROKER_LDADD<span class="k">)</span> -lm
<span class="k">else</span>
    BROKER_LDADD:<span class="o">=</span><span class="k">$(</span>BROKER_LDADD<span class="k">)</span> -ldl -lm  ../lib/libmysqlclient.a -lz -lpthread ../lib/libmosquitto.so.<span class="si">${</span><span class="nv">SOVERSION</span><span class="si">}</span>
endif
</pre></div>
</td></tr></table>

我们使用两个终端分别作为服务器和发布者，测试我们数据持久化代码的功能。一号终端执行

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mosquitto -c /etc/mosquitto/mosquitto.conf -v
</pre></div>
</td></tr></table>

二号终端执行

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mosquitto_pub -m <span class="s2">&quot;{\&quot;nodeID\&quot;:10001, \&quot;humidity\&quot;:12.5}&quot;</span> -t <span class="s2">&quot;mytopic&quot;</span> -u iot -P <span class="m">12345</span>
</pre></div>
</td></tr></table>

可以看到`mqtt_user`数据库的`recorddata`表中新增了如下数据：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mysql&gt; <span class="k">select</span> * from recorddata<span class="p">;</span>
+----------+---------------------+----------------------+
<span class="p">|</span> username <span class="p">|</span> date                <span class="p">|</span> data                 <span class="p">|</span>
+----------+---------------------+----------------------+
<span class="p">|</span> iot      <span class="p">|</span> <span class="m">2019</span>-10-04 <span class="m">21</span>:57:08 <span class="p">|</span> <span class="o">{</span><span class="s2">&quot;humidity&quot;</span>:<span class="s2">&quot;12.50&quot;</span><span class="o">}</span> <span class="p">|</span>
+----------+---------------------+----------------------+
<span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>
</pre></div>
</td></tr></table>

证明数据插入成功，数据持久化功能正常。

# MQTT安卓开发

## 添加依赖

在项目根目录下的build.gradle中添加：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">repositories</span> <span class="p">{</span>
    <span class="n">maven</span> <span class="p">{</span>
        <span class="n">url</span> <span class="s">&quot;https://repo.eclipse.org/content/repositories/paho-releases/&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

然后在app目录下的build.gradle中添加：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">dependencies</span> <span class="p">{</span>
    <span class="n">implementation</span> <span class="err">&#39;</span><span class="n">org</span><span class="p">.</span><span class="na">eclipse</span><span class="p">.</span><span class="na">paho</span><span class="p">:</span><span class="n">org</span><span class="p">.</span><span class="na">eclipse</span><span class="p">.</span><span class="na">paho</span><span class="p">.</span><span class="na">android</span><span class="p">.</span><span class="na">service</span><span class="p">:</span><span class="mf">1.1.1</span><span class="err">&#39;</span>
    <span class="n">implementation</span> <span class="err">&#39;</span><span class="n">org</span><span class="p">.</span><span class="na">eclipse</span><span class="p">.</span><span class="na">paho</span><span class="p">:</span><span class="n">org</span><span class="p">.</span><span class="na">eclipse</span><span class="p">.</span><span class="na">paho</span><span class="p">.</span><span class="na">client</span><span class="p">.</span><span class="na">mqttv3</span><span class="p">:</span><span class="mf">1.1.1</span><span class="err">&#39;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

注意：上述依赖编译需要 Android Studio 能够访问 `dl.google.com`，因此需要提前配置计算机能够访问谷歌网站。

## 声明权限

在AndroidManifest.xml中添加：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.READ_PHONE_STATE&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.INTERNET&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</td></tr></table>

## 开启服务

同样是在AndroidManifest.xml中添加：

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c">&lt;!-- Mqtt服务 --&gt;</span>
<span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">&quot;org.eclipse.paho.android.service.MqttService&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</td></tr></table>

## 具体实现

我们可以把MQTTD的配置放入Service中去，所以需要创建一个Service，Android studio中可以快捷创建Service，具体操作是`File→New→Service→Service`。

这样会自动在AndroidManifest.xml声明该服务，如果你是通过创建Java类的方式创建服务的，千万别忘了在AndroidManifest.xml中进行声明。

下面是Service的代码：
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/iot-book" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.808e90bb.js"></script>
      
        
        
          
          <script src="../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
        <script src="../../../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>